<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleSQLDB Studio - Unified Database Management</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .code-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .pulse-status {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .terminal-output {
            background: #0f172a;
            border: 1px solid #10b981;
            border-radius: 6px;
            padding: 16px;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 12px;
            font-weight: 500;
            color: #10b981;
            line-height: 1.8;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.5px;
        }

        .terminal-output div {
            margin: 4px 0;
        }

        .terminal-label {
            color: #60a5fa;
            font-weight: 600;
        }

        .terminal-value {
            color: #10b981;
        }

        .terminal-key {
            color: #fbbf24;
        }

        .breadcrumb-item {
            display: inline-flex;
            align-items: center;
        }

        .breadcrumb-item::after {
            content: 'â€º';
            margin: 0 12px;
            color: #64748b;
        }

        .breadcrumb-item:last-child::after {
            display: none;
        }
    </style>
</head>

<body class="bg-slate-900 text-gray-100" x-data="studioApp()">
    <div class="flex h-screen overflow-hidden">

        <!-- SIDEBAR NAVIGATION -->
        <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b border-slate-800">
                <div class="flex items-center space-x-3 mb-2">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center shadow-lg shadow-emerald-500/20">
                        <i data-lucide="database" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold tracking-tight text-white">SimpleSQLDB</h1>
                        <p class="text-xs text-emerald-500 font-medium">Workbench</p>
                    </div>
                </div>
            </div>

            <!-- Database Selector -->
            <div class="p-4">
                <div class="mb-4">
                    <label class="block text-[11px] font-semibold text-slate-500 uppercase tracking-wider mb-2">Active
                        Database</label>
                    <div class="relative">
                        <select x-model="currentDatabase" @change="useDatabase()"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs text-gray-200 focus:outline-none focus:border-emerald-500 appearance-none">
                            <template x-for="db in databases" :key="db.name">
                                <option :value="db.name" x-text="db.name" :selected="db.current"></option>
                            </template>
                        </select>
                        <i data-lucide="chevron-down"
                            class="w-3 h-3 text-gray-500 absolute right-3 top-2.5 pointer-events-none"></i>
                    </div>
                </div>

                <!-- Create DB / Table Actions -->
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <button @click="showCreateDbModal = true"
                        class="flex items-center justify-center space-x-1 px-2 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded text-xs text-gray-300 transition">
                        <i data-lucide="plus" class="w-3 h-3"></i>
                        <span>New DB</span>
                    </button>
                    <button @click="openCreateTableModal()"
                        class="flex items-center justify-center space-x-1 px-2 py-2 bg-emerald-500/10 hover:bg-emerald-500/20 border border-emerald-500/30 rounded text-xs text-emerald-400 transition">
                        <i data-lucide="table" class="w-3 h-3"></i>
                        <span>New Table</span>
                    </button>
                </div>

                <div class="mb-2 flex items-center justify-between">
                    <h3 class="text-[11px] font-semibold text-slate-500 uppercase tracking-wider">Tables</h3>
                    <button @click="loadTables()" class="text-slate-500 hover:text-emerald-400 transition"
                        title="Refresh">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto space-y-0.5 custom-scrollbar -mx-2 px-2 max-h-[calc(100vh-300px)]">
                    <template x-for="t in tables" :key="t.table_name">
                        <button @click="loadTableData(t.table_name)"
                            :class="currentTable === t.table_name ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/50' : 'text-slate-400 hover:bg-slate-800 border-transparent'"
                            class="w-full flex items-center justify-between px-3 py-2 text-xs rounded-md border text-left group transition">
                            <div class="flex items-center space-x-2 overflow-hidden">
                                <i data-lucide="table-2" class="w-3 h-3 flex-shrink-0"
                                    :class="currentTable === t.table_name ? 'text-emerald-500' : 'text-slate-600 group-hover:text-slate-500'"></i>
                                <span class="truncate" x-text="t.table_name"></span>
                            </div>
                            <span class="text-[10px] text-slate-600" x-text="t.row_count"></span>
                        </button>
                    </template>
                    <div x-show="tables.length === 0" class="text-xs text-slate-600 px-3 py-4 text-center italic">
                        No tables found. Create one!
                    </div>
                </div>
            </div>

            <div class="mt-auto p-4 border-t border-slate-800">
                <button @click="currentView = 'terminal'"
                    :class="currentView === 'terminal' ? 'bg-slate-800 text-emerald-400' : 'text-slate-400 hover:text-white'"
                    class="w-full flex items-center space-x-2 px-3 py-2 rounded-lg text-xs transition">
                    <i data-lucide="terminal" class="w-4 h-4"></i>
                    <span>SQL Terminal</span>
                </button>
                <button @click="loadErd()"
                    :class="currentView === 'erd' ? 'bg-slate-800 text-emerald-400' : 'text-slate-400 hover:text-white'"
                    class="w-full flex items-center space-x-2 px-3 py-2 rounded-lg text-xs transition mt-1">
                    <i data-lucide="share-2" class="w-4 h-4"></i>
                    <span>Schema Visualizer</span>
                </button>
                <div class="mt-3 flex items-center space-x-2 text-[10px] text-slate-600">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span>System Online</span>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col overflow-hidden bg-slate-950">

            <!-- Context Header -->
            <header
                class="bg-slate-900/50 border-b border-slate-800 px-6 py-3 flex items-center justify-between backdrop-blur-sm">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center text-sm text-slate-400">
                        <i data-lucide="database" class="w-4 h-4 mr-2 text-slate-600"></i>
                        <span x-text="currentDatabase"></span>
                        <span class="mx-2 text-slate-600">/</span>
                        <span x-show="currentView === 'table'" class="flex items-center text-white font-medium">
                            <i data-lucide="table" class="w-4 h-4 mr-2 text-emerald-500"></i>
                            <span x-text="currentTable"></span>
                        </span>
                        <span x-show="currentView === 'terminal'" class="text-white font-medium">SQL Terminal</span>
                        <span x-show="currentView === 'erd'" class="text-white font-medium">Schema Visualizer</span>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button x-show="currentView === 'table'" @click="loadTableData(currentTable)"
                        class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded transition">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                    <button x-show="currentView === 'erd'" @click="loadErd()"
                        class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded transition"
                        title="Refresh Diagram">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
            </header>

            <!-- CONTENT AREA -->
            <div class="flex-1 overflow-hidden relative">

                <!-- ===== TABLE DATA VIEW ===== -->
                <div x-show="currentView === 'table'" class="h-full flex flex-col">
                    <!-- Toolbar -->
                    <div class="px-6 py-3 border-b border-slate-800 flex items-center justify-between bg-slate-900/20">
                        <div class="flex items-center space-x-4">
                            <div class="text-xs text-slate-400">
                                <span class="font-mono text-emerald-500" x-text="tableData.count"></span> rows
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button @click="exportCsv()"
                            class="flex items-center space-x-1 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded text-xs transition">
                            <i data-lucide="download" class="w-3 h-3"></i>
                            <span>Export</span>
                        </button>
                        <label
                            class="flex items-center space-x-1 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded text-xs transition cursor-pointer">
                            <i data-lucide="upload" class="w-3 h-3"></i>
                            <span>Import</span>
                            <input type="file" class="hidden" @change="importCsv($event)">
                        </label>
                        <div class="h-4 w-px bg-slate-700 mx-1"></div>
                        <button @click="openAddRowModal()"
                            class="flex items-center space-x-1 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-xs font-medium transition shadow-lg shadow-emerald-900/20">
                            <i data-lucide="plus" class="w-3 h-3"></i>
                            <span>Add Row</span>
                        </button>
                    </div>


                    <!-- Data Grid -->
                    <div class="flex-1 overflow-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-900 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <template x-for="col in tableData.columns" :key="col.name">
                                        <th
                                            class="px-4 py-3 text-xs font-semibold text-slate-400 border-b border-slate-800 whitespace-nowrap bg-slate-900">
                                            <div class="flex items-center space-x-1">
                                                <span x-text="col.name"></span>
                                                <i x-show="col.is_pk" data-lucide="key"
                                                    class="w-3 h-3 text-yellow-500"></i>
                                                <i x-show="col.is_fk" data-lucide="link"
                                                    class="w-3 h-3 text-blue-500"></i>
                                                <span class="text-[10px] text-slate-600 font-normal uppercase ml-1"
                                                    x-text="col.type"></span>
                                            </div>
                                        </th>
                                    </template>
                                    <th
                                        class="px-4 py-3 text-xs font-semibold text-slate-400 border-b border-slate-800 w-20 bg-slate-900">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800">
                                <template x-for="(row, idx) in tableData.rows" :key="idx">
                                    <tr class="hover:bg-slate-800/50 group transition-colors">
                                        <template x-for="col in tableData.columns" :key="col.name">
                                            <td
                                                class="px-4 py-2 text-xs text-slate-300 whitespace-nowrap border-r border-slate-800/50 last:border-r-0">
                                                <div class="truncate max-w-[200px]"
                                                    x-text="row[col.name] !== null ? row[col.name] : 'NULL'"
                                                    :class="row[col.name] === null ? 'text-slate-600 italic' : ''">
                                                </div>
                                            </td>
                                        </template>
                                        <td class="px-4 py-2 text-xs border-r border-slate-800/50">
                                            <div
                                                class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button @click="openEditRowModal(row)"
                                                    class="text-blue-400 hover:text-blue-300" title="Edit">
                                                    <i data-lucide="pencil" class="w-3 h-3"></i>
                                                </button>
                                                <button @click="deleteRow(row)" class="text-red-400 hover:text-red-300"
                                                    title="Delete">
                                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="tableData.rows.length === 0">
                                    <td :colspan="tableData.columns.length + 1"
                                        class="px-6 py-12 text-center text-slate-500 text-sm">
                                        No data found in this table.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ===== SQL TERMINAL VIEW ===== -->
            <div x-show="currentView === 'terminal'" class="h-full flex flex-col p-6">
                <div class="flex-1 bg-slate-900 rounded-lg border border-slate-800 flex flex-col overflow-hidden">
                    <div class="px-4 py-2 border-b border-slate-800 bg-slate-800/50 flex items-center justify-between">
                        <span class="text-xs font-medium text-slate-400">Query Editor</span>
                        <div class="flex space-x-2">
                            <button @click="executeSql()"
                                class="px-3 py-1 bg-emerald-600 hover:bg-emerald-500 text-white rounded text-xs transition flex items-center space-x-1">
                                <i data-lucide="play" class="w-3 h-3"></i>
                                <span>Run</span>
                            </button>
                            <button @click="sqlQuery = ''"
                                class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded text-xs transition">Clear</button>
                        </div>
                    </div>
                    <div class="h-48">
                        <textarea x-model="sqlQuery"
                            class="w-full h-full bg-slate-950 text-gray-200 p-4 code-editor focus:outline-none resize-none text-sm"
                            placeholder="SELECT * FROM students LIMIT 10;"></textarea>
                    </div>

                    <!-- Results Pane -->
                    <div class="flex-1 border-t border-slate-800 flex flex-col min-h-0">
                        <div class="px-4 py-2 bg-slate-800/30 border-b border-slate-800">
                            <span class="text-xs text-slate-500">Output</span>
                        </div>
                        <div class="flex-1 overflow-auto p-4 bg-slate-950">
                            <div x-show="!sqlResults" class="text-slate-600 text-sm font-mono">Ready to execute
                                query...</div>
                            <div x-show="sqlResults && !sqlResults.success" class="text-red-400 font-mono text-sm"
                                x-text="sqlResults?.error"></div>

                            <div x-show="sqlResults && sqlResults.success">
                                <div class="mb-2 text-xs text-emerald-500 font-mono"
                                    x-text="sqlResults?.message || 'Query successful'"></div>
                                <div x-show="sqlResults?.rows" class="overflow-x-auto">
                                    <table class="w-full text-left border-collapse">
                                        <thead class="bg-slate-900">
                                            <tr>
                                                <template x-for="col in Object.keys(sqlResults?.rows?.[0] || {})"
                                                    :key="col">
                                                    <th class="px-3 py-2 text-xs text-slate-400 border border-slate-800"
                                                        x-text="col"></th>
                                                </template>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="(row, idx) in sqlResults?.rows" :key="idx">
                                                <tr>
                                                    <template x-for="col in Object.keys(row)" :key="col">
                                                        <td class="px-3 py-2 text-xs text-slate-300 border border-slate-800 font-mono"
                                                            x-text="row[col]"></td>
                                                    </template>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== ERD VIEW ===== -->
            <div x-show="currentView === 'erd'" class="h-full flex flex-col p-6 bg-slate-950">
                <div
                    class="flex-1 bg-slate-900/50 rounded-lg border border-slate-800 flex flex-col overflow-hidden relative">
                    <div class="absolute top-4 right-4 z-10 flex space-x-2">
                        <div
                            class="px-3 py-1.5 bg-slate-900/80 backdrop-blur border border-slate-700 rounded-md text-xs text-slate-400 shadow-lg">
                            <span class="text-emerald-500 font-bold">Mermaid.js</span> Rendering
                        </div>
                    </div>
                    <div
                        class="flex-1 overflow-auto p-8 flex items-center justify-center bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-100">
                        <div id="mermaid-container" class="w-full h-full flex items-center justify-center"></div>
                    </div>
                </div>
            </div>

    </div>
    </main>
    <!-- MODALS -->

    <!-- Create Database Modal -->
    <div x-show="showCreateDbModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showCreateDbModal = false"></div>
        <div
            class="relative w-full max-w-sm mx-4 bg-slate-900 border border-slate-700 rounded-lg overflow-hidden shadow-2xl">
            <div class="px-5 py-3 border-b border-slate-800 flex items-center justify-between bg-slate-800/50">
                <h3 class="font-semibold text-sm text-gray-200">New Database</h3>
                <button @click="showCreateDbModal=false" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-4 h-4"></i></button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Database
                        Name</label>
                    <input x-model="newDatabaseName" type="text"
                        class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-sm text-white focus:border-emerald-500 focus:outline-none placeholder-slate-600"
                        placeholder="my_database" @keydown.enter="createDatabase(); showCreateDbModal=false" />
                </div>
                <div class="flex items-center justify-end space-x-2 pt-2">
                    <button @click="showCreateDbModal=false"
                        class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded text-xs text-slate-300 transition">Cancel</button>
                    <button @click="createDatabase(); showCreateDbModal=false"
                        class="px-3 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-xs text-white transition font-medium">Create
                        Database</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Table Modal -->
    <div x-show="showCreateTableModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showCreateTableModal = false"></div>
        <div
            class="relative w-full max-w-2xl mx-4 bg-slate-900 border border-slate-700 rounded-lg overflow-hidden shadow-2xl flex flex-col max-h-[85vh]">
            <div class="px-5 py-3 border-b border-slate-800 flex items-center justify-between bg-slate-800/50">
                <h3 class="font-semibold text-sm text-gray-200">Design New Table</h3>
                <button @click="showCreateTableModal=false" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-4 h-4"></i></button>
            </div>
            <div class="p-5 flex-1 overflow-auto space-y-5">
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Table
                        Name</label>
                    <input x-model="createTableForm.name" type="text"
                        class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-sm text-white focus:border-emerald-500 focus:outline-none placeholder-slate-600"
                        placeholder="e.g. users" />
                </div>

                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide">Columns</label>
                        <button @click="addConnectTableColumn()"
                            class="text-xs text-emerald-400 hover:text-emerald-300 flex items-center space-x-1">
                            <i data-lucide="plus" class="w-3 h-3"></i>
                            <span>Add Column</span>
                        </button>
                    </div>
                    <div class="space-y-2">
                        <template x-for="(col, idx) in createTableForm.columns" :key="idx">
                            <div class="flex items-start space-x-2 bg-slate-950 p-2 rounded border border-slate-800/50">
                                <div class="flex-1">
                                    <input x-model="col.name" placeholder="Column Name"
                                        class="w-full bg-transparent text-xs text-white placeholder-slate-600 border-b border-slate-800 focus:border-emerald-500 focus:outline-none px-1 py-1" />
                                </div>
                                <div class="w-24">
                                    <select x-model="col.type"
                                        class="w-full bg-slate-900 text-xs text-slate-300 border border-slate-800 rounded px-1 py-1">
                                        <option value="INT">INT</option>
                                        <option value="VARCHAR">VARCHAR</option>
                                        <option value="TEXT">TEXT</option>
                                        <option value="JSON">JSON</option>
                                        <option value="FLOAT">FLOAT</option>
                                        <option value="BOOLEAN">BOOLEAN</option>
                                        <option value="DATE">DATE</option>
                                    </select>
                                </div>
                                <div class="flex items-center space-x-3 px-1 pt-1.5">
                                    <label class="flex items-center space-x-1 cursor-pointer" title="Primary Key">
                                        <input type="checkbox" x-model="col.pk"
                                            class="rounded bg-slate-800 border-slate-700 text-emerald-500 focus:ring-0 w-3 h-3" />
                                        <span class="text-[10px] text-slate-500 font-mono">PK</span>
                                    </label>
                                    <label class="flex items-center space-x-1 cursor-pointer" title="Not Null">
                                        <input type="checkbox" x-model="col.nn"
                                            class="rounded bg-slate-800 border-slate-700 text-emerald-500 focus:ring-0 w-3 h-3" />
                                        <span class="text-[10px] text-slate-500 font-mono">NN</span>
                                    </label>
                                    <label class="flex items-center space-x-1 cursor-pointer" title="Unique">
                                        <input type="checkbox" x-model="col.uq"
                                            class="rounded bg-slate-800 border-slate-700 text-emerald-500 focus:ring-0 w-3 h-3" />
                                        <span class="text-[10px] text-slate-500 font-mono">UQ</span>
                                    </label>
                                </div>
                                <button @click="removeCreateTableColumn(idx)"
                                    class="text-slate-600 hover:text-red-400 pt-1">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <div class="px-5 py-3 border-t border-slate-800 bg-slate-800/50 flex justify-end space-x-2">
                <button @click="showCreateTableModal=false"
                    class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded text-xs text-slate-300 transition">Cancel</button>
                <button @click="saveTable()"
                    class="px-3 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-xs text-white transition font-medium">Create
                    Table</button>
            </div>
        </div>
    </div>

    <!-- Row Editor Modal -->
    <div x-show="showRowModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeRowModal()"></div>
        <div
            class="relative w-full max-w-lg mx-4 bg-slate-900 border border-slate-700 rounded-lg overflow-hidden shadow-2xl flex flex-col max-h-[85vh]">
            <div class="px-5 py-3 border-b border-slate-800 flex items-center justify-between bg-slate-800/50">
                <h3 class="font-semibold text-sm text-gray-200"
                    x-text="rowFormMode === 'edit' ? 'Edit Row' : 'Add Row'"></h3>
                <button @click="closeRowModal()" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-4 h-4"></i></button>
            </div>
            <div class="p-5 flex-1 overflow-auto space-y-4">
                <template x-for="col in tableData.columns" :key="col.name">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1.5">
                            <span x-text="col.name"></span>
                            <span x-show="col.is_pk" class="ml-1 text-[10px] text-yellow-500">(PK)</span>
                            <span x-show="col.type" class="ml-1 text-[10px] text-slate-600 font-normal uppercase"
                                x-text="col.type"></span>
                        </label>

                        <!-- Input types based on standard SQL types -->
                        <div x-data="{ isDisabled: (rowFormMode === 'edit' && col.is_pk) }">

                            <!-- Boolean -->
                            <select x-show="col.type === 'BOOLEAN'" x-model="rowForm[col.name]" :disabled="isDisabled"
                                class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-sm text-white focus:border-emerald-500 focus:outline-none placeholder-slate-600 disabled:opacity-50">
                                <option value="true">TRUE</option>
                                <option value="false">FALSE</option>
                            </select>

                            <!-- Date -->
                            <input x-show="col.type === 'DATE'" type="date" x-model="rowForm[col.name]"
                                :disabled="isDisabled"
                                class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-sm text-white focus:border-emerald-500 focus:outline-none placeholder-slate-600 disabled:opacity-50" />

                            <!-- Number -->
                            <input x-show="['INT', 'FLOAT'].includes(col.type)" type="number"
                                x-model="rowForm[col.name]" :disabled="isDisabled" step="any"
                                class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-sm text-white focus:border-emerald-500 focus:outline-none placeholder-slate-600 disabled:opacity-50" />



                            <!-- Long Text / JSON -->
                            <textarea x-show="['TEXT', 'JSON'].includes(col.type)" x-model="rowForm[col.name]"
                                :disabled="isDisabled" rows="3"
                                class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-sm text-white font-mono focus:border-emerald-500 focus:outline-none placeholder-slate-600 disabled:opacity-50"></textarea>

                            <!-- Text/Default -->
                            <input x-show="!['BOOLEAN', 'DATE', 'INT', 'FLOAT', 'TEXT', 'JSON'].includes(col.type)"
                                type="text" x-model="rowForm[col.name]" :disabled="isDisabled"
                                class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 text-sm text-white focus:border-emerald-500 focus:outline-none placeholder-slate-600 disabled:opacity-50" />

                        </div>
                    </div>
                </template>
            </div>
            <div class="px-5 py-3 border-t border-slate-800 bg-slate-800/50 flex justify-end space-x-2">
                <button @click="closeRowModal()"
                    class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded text-xs text-slate-300 transition">Cancel</button>
                <button @click="saveRow()"
                    class="px-3 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-xs text-white transition font-medium">Save
                    Row</button>
            </div>
        </div>
    </div>


    <script>
        function studioApp() {
            return {
                currentView: 'table', // or 'terminal'
                currentTable: '',
                currentDatabase: '',

                databases: [],
                tables: [],

                // Generic Table Data
                tableData: {
                    rows: [],
                    columns: [], // {name, type, is_pk, is_fk}
                    count: 0
                },

                // SQL Terminal
                sqlQuery: '',
                sqlResults: null,
                explainOutput: null,

                // Modals
                showCreateDbModal: false,
                newDatabaseName: '',

                showCreateTableModal: false,
                createTableForm: {
                    name: '',
                    columns: []
                },

                showRowModal: false,
                rowFormMode: 'add',
                rowForm: {},

                async init() {
                    await this.loadDatabases();
                    if (this.currentDatabase) {
                        await this.loadTables();
                        if (this.tables.length > 0) {
                            // Load first table by default
                            await this.loadTableData(this.tables[0].table_name);
                        }
                    }
                    lucide.createIcons();
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: 'dark',
                        themeVariables: {
                            darkMode: true,
                            background: '#0f172a',
                            primaryColor: '#10b981',
                            mainBkg: '#1e293b',
                            nodeBorder: '#334155',
                            lineColor: '#64748b',
                            textColor: '#cbd5e1'
                        }
                    });
                },

                // === ERD Generator ===
                async loadErd() {
                    this.currentView = 'erd';
                    const container = document.getElementById('mermaid-container');
                    container.innerHTML = '<div class="text-slate-500 animate-pulse">Generating Schema Diagram...</div>';

                    try {
                        const res = await fetch('/api/schema/full');
                        const data = await res.json();

                        if (!data.success) throw new Error(data.error);

                        let graph = 'erDiagram\n';
                        const schema = data.schema || [];

                        if (schema.length === 0) {
                            container.innerHTML = '<div class="text-slate-500">No tables found to visualize.</div>';
                            return;
                        }

                        // Define entities
                        schema.forEach(table => {
                            graph += `    ${table.table_name} {\n`;
                            table.columns.forEach(col => {
                                const type = col.type.toLowerCase();
                                const key = col.is_pk ? 'PK' : (col.is_fk ? 'FK' : '');
                                graph += `        ${type} ${col.name} ${key}\n`;
                            });
                            graph += `    }\n`;
                        });

                        // Define relationships
                        schema.forEach(table => {
                            table.columns.forEach(col => {
                                if (col.is_fk && col.fk_target) {
                                    // table }o--|| target : "references"
                                    graph += `    ${table.table_name} }o--|| ${col.fk_target.table} : "${col.name}"\n`;
                                }
                            });
                        });

                        // Render
                        const { svg } = await mermaid.render('graphDiv', graph);
                        container.innerHTML = svg;

                    } catch (e) {
                        console.error(e);
                        container.innerHTML = `<div class="text-red-400">Failed to render ERD: ${e.message}</div>`;
                    }
                },

                // === Databases ===
                async loadDatabases() {
                    try {
                        const res = await fetch('/api/databases');
                        const data = await res.json();
                        if (data.success) {
                            this.databases = data.databases || [];
                            this.currentDatabase = data.current || (this.databases[0]?.name || '');
                        }
                    } catch (e) { console.error(e); }
                },

                async useDatabase() {
                    if (!this.currentDatabase) return;
                    try {
                        const res = await fetch('/api/databases/use', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: this.currentDatabase })
                        });
                        const data = await res.json();
                        if (data.success) {
                            // Reset state
                            this.currentTable = '';
                            this.tableData = { rows: [], columns: [], count: 0 };
                            this.tables = [];
                            await this.loadTables();
                        } else {
                            alert(data.error);
                        }
                    } catch (e) {
                        alert('Connection error');
                    }
                },

                async createDatabase() {
                    if (!this.newDatabaseName) return;
                    try {
                        const res = await fetch('/api/databases', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: this.newDatabaseName })
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.newDatabaseName = '';
                            await this.loadDatabases();
                        } else {
                            alert(data.error);
                        }
                    } catch (e) { alert(e); }
                },

                // === Tables List ===
                async loadTables() {
                    try {
                        const res = await fetch('/api/tables');
                        const data = await res.json();
                        if (data.success) {
                            this.tables = data.tables || [];
                            this.$nextTick(() => lucide.createIcons());
                        }
                    } catch (e) { console.error(e); }
                },

                // === Generic Table Data ===
                async loadTableData(tableName) {
                    this.currentTable = tableName;
                    this.currentView = 'table';
                    try {
                        const res = await fetch(`/api/table/${tableName}`);
                        const data = await res.json();
                        if (data.success) {
                            this.tableData = {
                                rows: data.rows,
                                columns: data.columns,
                                count: data.count
                            };
                            this.$nextTick(() => lucide.createIcons());
                        } else {
                            alert(data.error);
                        }
                    } catch (e) { console.error(e); }
                },

                async refreshData() {
                    if (this.currentView === 'table' && this.currentTable) {
                        await this.loadTableData(this.currentTable);
                    }
                },

                // === Create Table ===
                openCreateTableModal() {
                    this.createTableForm = {
                        name: '',
                        columns: [
                            { name: 'id', type: 'INT', pk: true, nn: true, uq: false }
                        ]
                    };
                    this.showCreateTableModal = true;
                },

                addConnectTableColumn() {
                    this.createTableForm.columns.push({ name: '', type: 'VARCHAR', pk: false, nn: false, uq: false });
                },

                removeCreateTableColumn(idx) {
                    this.createTableForm.columns.splice(idx, 1);
                },

                async saveTable() {
                    if (!this.createTableForm.name) return alert('Table name required');
                    try {
                        const res = await fetch('/api/tables/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.createTableForm)
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.showCreateTableModal = false;
                            await this.loadTables();
                            await this.loadTableData(this.createTableForm.name);
                        } else {
                            alert(data.error);
                        }
                    } catch (e) { alert(e); }
                },

                // === Row Operations ===
                openAddRowModal() {
                    if (!this.currentTable) return;
                    this.rowFormMode = 'add';
                    this.rowForm = {};

                    // Pre-fill defaults or empty strings
                    this.tableData.columns.forEach(col => {
                        this.rowForm[col.name] = '';
                    });

                    this.showRowModal = true;
                },

                openEditRowModal(row) {
                    this.rowFormMode = 'edit';
                    // Clone row to form
                    this.rowForm = { ...row };
                    this.showRowModal = true;
                },

                closeRowModal() {
                    this.showRowModal = false;
                },

                async saveRow() {
                    let url = `/api/table/${this.currentTable}`;
                    let method = 'POST';

                    if (this.rowFormMode === 'edit') {
                        // Find PK
                        const pkCol = this.tableData.columns.find(c => c.is_pk);
                        if (!pkCol) return alert('Cannot edit table without Primary Key');
                        const pkVal = this.rowForm[pkCol.name];
                        url += `/${pkVal}`;
                        method = 'PUT';
                    }

                    try {
                        const res = await fetch(url, {
                            method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.rowForm)
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.closeRowModal();
                            await this.loadTableData(this.currentTable);
                        } else {
                            alert(data.error);
                        }
                    } catch (e) { alert(e); }
                },

                async deleteRow(row) {
                    if (!confirm('Are you sure you want to delete this row?')) return;

                    const pkCol = this.tableData.columns.find(c => c.is_pk);
                    if (!pkCol) return alert('Cannot delete from table without Primary Key');

                    const pkVal = row[pkCol.name];
                    try {
                        const res = await fetch(`/api/table/${this.currentTable}/${pkVal}`, {
                            method: 'DELETE'
                        });
                        const data = await res.json();
                        if (data.success) {
                            await this.loadTableData(this.currentTable);
                        } else {
                            alert(data.error);
                        }
                    } catch (e) { alert(e); }
                },

                // === Import / Export ===
                async exportCsv() {
                    try {
                        const res = await fetch(`/api/table/${this.currentTable}/export`);
                        const data = await res.json();
                        if (data.success) {
                            // Trigger download
                            const blob = new Blob([data.csv], { type: 'text/csv' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = data.filename;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            a.remove();
                        } else {
                            alert(data.error);
                        }
                    } catch (e) { alert(e); }
                },

                async importCsv(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const csvContent = e.target.result;
                        try {
                            const res = await fetch(`/api/table/${this.currentTable}/import`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ csv: csvContent })
                            });
                            const data = await res.json();
                            if (data.success) {
                                alert(data.message);
                                if (data.errors && data.errors.length > 0) {
                                    alert('Some rows failed: \n' + data.errors.join('\n'));
                                }
                                await this.loadTableData(this.currentTable);
                            } else {
                                alert(data.error);
                            }
                        } catch (err) { alert(err); }
                        // Reset input
                        event.target.value = '';
                    };
                    reader.readAsText(file);
                },


                // === SQL Terminal ===
                async executeSql() {
                    try {
                        const res = await fetch('/api/execute', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sql: this.sqlQuery })
                        });
                        this.sqlResults = await res.json();
                    } catch (e) { alert(e); }
                },

                async explainSql() {
                    try {
                        const res = await fetch('/api/explain', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sql: this.sqlQuery })
                        });
                        const data = await res.json();
                        this.explainOutput = data.plan;
                    } catch (e) { alert(e); }
                },

                formatExplainOutput(plan) {
                    if (!plan) return '';
                    const esc = (s) => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                    const walk = (node, prefix = '', isLast = true) => {
                        const connector = isLast ? 'â””â”€ ' : 'â”œâ”€ ';
                        const type = esc(node?.type || 'UNKNOWN');
                        let line = `<div><span class="terminal-key">${esc(prefix + connector + type)}</span>`;

                        if (node?.details) {
                            const d = typeof node.details === 'string' ? node.details : JSON.stringify(node.details);
                            line += ` <span class="terminal-value">${esc(d)}</span>`;
                        }
                        line += `</div>`;

                        const children = node?.children || [];
                        const nextPrefix = prefix + (isLast ? '   ' : 'â”‚  ');
                        for (let i = 0; i < children.length; i++) {
                            line += walk(children[i], nextPrefix, i === children.length - 1);
                        }
                        return line;
                    };
                    return walk(plan, '', true);
                },

                getPageTitle() {
                    return 'SimpleSQLDB Studio';
                }
            }
        }
    </script>
</body>

</html>